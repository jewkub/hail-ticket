<!doctype html>
<!-- Coded by Jew -->
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css" integrity="sha256-iXUYfkbVl5itd4bAkFH5mjMEN5ld9t3OHvXX3IU8UxU=" crossorigin="anonymous" />
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"/> -->
    <link rel="stylesheet" href="/bootstrap.min.css"/>
    
    <title>บ้าน 7 จองล่วงหน้า</title>
    <style>
      html {
        position: relative;
        min-height: 100%;
      }
      body {
        height: 100%;
        margin-bottom: 60px; /* Margin bottom by footer height */
      }
      .footer {
        position: absolute;
        bottom: 0;
        min-width: 100%;
        height: 60px; /* Set the fixed height of the footer here */
        line-height: 60px; /* Vertically center the text there */
        background-color: var(--purple);
      }
      .footer .text-muted {
        color: whitesmoke !important;
      }
      .btn-primary {
        border-color: fuchsia;
        background-color: fuchsia;
      }
      .btn-primary:hover {
        border-color: purple;
        background-color: purple;
      }
      .btn-primary:focus {
        border-color: fuchsia;
        background-color: fuchsia;
      }
      .btn-primary:active {
        border-color: purple !important;
        background-color: purple !important;
      }
      .btn-success.disabled, .btn-success:disabled {
        border-color: var(--red);
        background-color: var(--red);
      }
      .btn-success:disabled:active {
        border-color: var(--red) !important;
        background-color: var(--red) !important;
      }
    </style>
  </head>
  <body>
    <div class="Jew" style="display: none"> Eiei </div>
    <div class="modal fade" id="ticketModal" tabindex="-1" role="dialog" aria-labelledby="ticketModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="ticketModalLabel">เงื่อนไขการจอง</h5>
          </div>
          <div class="modal-body">
            การจองจะทำได้เป็นรอบๆ ในแต่ละรอบมีเวลาเล่น 7 นาที<br>
            มีทั้งหมด 4 ห้อง แต่ละห้องจำกัด 4-8 คนในแต่ละรอบ<br>
            กรุณามาล่วงหน้าอย่างน้อย 5 นาที มิเช่นนั้นอาจถือได้ว่าสละสิทธิ์<br>
            ค่าเข้า ห้องละ 50 บาท (เข้าทุกห้อง 180 บาท)<br>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
            <button type="button" class="btn btn-primary" id="acceptButton">โอเค</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="confirmModalLabel">ยืนยันการจอง</h5>
          </div>
          <div class="modal-body" id="confirmText">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">ยกเลิก</button>
            <button type="button" class="btn btn-primary" id="bookButton">ยืนยัน</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="successModalLabel">การจองสำเร็จ</h5>
          </div>
          <div class="modal-body" id="successBody">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">โอเค</button>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <br>
      <div id="welcome" style="display:none">
        <h1>บ้าน 7 (Merlin's Oath)</h1>
        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#ticketModal" data-backdrop="static">จองเลย!</button>
      </div>
      <div id="booking" style="display:none" class="">
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header">
                <h5>ข้อมูล</h5>
              </div>
              <div class="card-body">
                <form novalidate>
                  <div class="form-group form-row">
                    <div class="col-md-4">
                      <label for="input" class="col-form-label">มากี่คน</label>
                    </div>
                    <div class="col-md-5">
                      <select class="form-control" id="input">
                        <option>4</option>
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-group form-row" id="nameDiv">
                    <div class="col-md-4">
                      <label for="name">ชื่อคนจอง</label>
                    </div>
                    <div class="col-md-5">
                      <input id="name" class="form-control" placeholder="ชื่อคนจอง" autocomplete="off" maxlength="50">
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <br>
        <div class="row">
          <div class="col">
            <h3>จำนวนที่ว่างที่เหลือในแต่ละรอบ</h3>
          </div>
        </div>
        <br>
        <div class="row">
          <div class="col">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th scope="col">รอบเวลา</th>
                  <th scope="col">ห้องสร้อย</th>
                  <th scope="col">ห้องจอก</th>
                  <th scope="col">ห้องคทา</th>
                  <th scope="col">ห้องดาบ</th>
                </tr>
              </thead>
              <tbody id="table">
              </tbody>
            </table>
          </div>
        </div>
        <br>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <span class="text-muted"><nobr>© Hailnight 2018 Wondermore, Baan 7 (Merlin's Oath)</nobr></span>
      </div>
    </footer>
    <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
    <script>
      // Initialize Firebase
      let config = {
        apiKey: "AIzaSyBNqMxI5VrDfBD0sogvqCxhlYD-ZUB8doE",
        authDomain: "hail-ticket.firebaseapp.com",
        databaseURL: "https://hail-ticket.firebaseio.com",
        projectId: "hail-ticket",
        storageBucket: "",
        messagingSenderId: "714587280975"
      };
      firebase.initializeApp(config);
    </script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.13.0/umd/popper.min.js" integrity="sha256-pS96pU17yq+gVu4KBQJi38VpSuKN7otMrDQprzf/DWY=" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js" integrity="sha256-ABVkpwb9K9PxubvRrHMkk6wmWcIHUE9eBxNZLXYQ84k=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js" integrity="sha256-FiZMk1zgTeujzf/+vomWZGZ9r00+xnGvOgXoj0Jo1jA=" crossorigin="anonymous"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.8/js/all.js" integrity="sha384-SlE991lGASHoBfWbelyBPLsUlwY1GwNDJo3jSJO04KZ33K2bwfV9YBauFfnzvynJ" crossorigin="anonymous"></script>
    <script defer type="text/babel">
      'use strict';

      let database = firebase.database();
      $('#welcome').show();
      $('#acceptButton').click(function () {
        $('#ticketModal').modal('toggle');
        $('#welcome').hide();
        $('#booking').show();
      });
      let data = void 0,
          table = {},
          now = [],
          num = void 0,
          cftime = void 0,
          cfroom = void 0, roomname = {room1: 'ห้องสร้อย', room2: 'ห้องจอก', room3: 'ห้องคทา', room4: 'ห้องดาบ'}
      $('#name').on('input focusout', e => {
        if($('#name').val() == ''){
          $('#name').addClass('is-invalid');
          if($('#blankWarn').length == 0) $('#nameDiv').append('<div id="blankWarn" class="col-md-3"><small class="text-danger">กรุณาระบุชื่อ</small></div>');
        }
        else {
          $('#blankWarn').remove();
          $('#name').removeClass('is-invalid');
        }
      });
      let confirm = (room, time) => {
        if ($('#name').val() == ''){
          $('#name').trigger('input');
          return false;
        }
        $('#confirmText').html('จำนวน ' + $('#input').val() + ' คน<br>จองเวลา ' + now[time].format('kk:mm') + '<br>' + roomname[room] + '<br>จองในนาม : ' + $('#name').val().replace('<', '&lt;') + '<br><br><div class="input-group"><div class="input-group-prepend"><span class="input-group-text">หมายเหตุ (ถ้ามี)</span></div><input type="text" class="form-control" id="note"></div>');
        cftime = time;
        cfroom = room;
        $('#confirmModal').modal({
          show: true,
          backdrop: 'static'
        });
      };
      $('#bookButton').click(() => {
        let ticket = '' + cfroom[4] + now[cftime].format('kkmm') + num + '-' + $('#name').val();
        database.ref('/order/').push().set({
          num: $('#input').val(),
          time: now[cftime].format('kk:mm'),
          room: roomname[cfroom],
          name: $('#name').val(),
          note: $('#note').val(),
          ticket: ticket
        });
        database.ref('/' + cfroom + '/' + cftime + '/').set({
          num: parseInt(data[cfroom][cftime].num) + parseInt($('#input').val())
        });
        $('#confirmModal').modal('hide');
        $('#confirmModal').one('hidden.bs.modal', () => {
          $('#successBody').html('กรุณาบันทึกภาพหน้าจอนี้ไว้เพื่อยืนยันการจองที่หน้างาน<br><br><div style="text-align: center" id="imgDiv"><img id="img" src="https://api.qrserver.com/v1/create-qr-code/?data=' + ticket + '&amp;size=250x250" alt="กำลังโหลด หากรูปไม่ขึ้น ให้กดปุ่มด้านล่าง" /></div><div style="text-align: center"><small>' + ticket + '</small></div><br><div style="text-align: center"><button type="button" class="btn btn-warning" id="reloadButton">รูปไม่ขึ้น ?</button></div>');
          $('#successModal').modal({
            keyboard: false,
            show: true,
            backdrop: 'static'
          });
          //$('#reloadButton').off();
          let f = () => {
            $('#successBody').html('กรุณาบันทึกภาพหน้าจอนี้ไว้เพื่อยืนยันการจองที่หน้างาน<br><br><div style="text-align: center" id="imgDiv"><img id="img" src="https://api.qrserver.com/v1/create-qr-code/?data=' + ticket + '&amp;size=250x250" alt="กำลังโหลด หากรูปไม่ขึ้น ให้กดปุ่มด้านล่าง" /></div><div style="text-align: center"><small>' + ticket + '</small></div><br><div style="text-align: center"><button type="button" class="btn btn-warning" id="reloadButton">รูปไม่ขึ้น ?</button></div>');
            // console.log('done');
            $('#reloadButton').one('click', f);
          };
          $('#reloadButton').one('click', f);
        });
      });
      database.ref('/').on('value', snap => {
        data = snap.val();
        //console.log(data);
        $('#table').empty();
        now[0] = moment();
        now[0].set({
          hour: 18,
          minute: 0,
          second: 0,
          millisecond: 0
        });
        for (let i = 0; i < 36; i++) {
          $('#table').append('<tr><th scope="row">' + now[i].format('kk:mm') + '</th><td><button type="button" class="btn btn-success num" onclick="confirm(\'room1\', ' + i + ')"' + (data.room1[i].num == 0 ? '><i class="fas fa-check"></i>' : ' disabled><i class="fas fa-times"></i>') + '</button></td><td><button type="button" class="btn btn-success num" onclick="confirm(\'room2\', ' + i + ')"' + (data.room2[i].num == 0 ? '><i class="fas fa-check"></i>' : ' disabled><i class="fas fa-times"></i>') + '</button></td><td><button type="button" class="btn btn-success num" onclick="confirm(\'room3\', ' + i + ')"' + (data.room3[i].num == 0 ? '><i class="fas fa-check"></i>' : ' disabled><i class="fas fa-times"></i>') + '</button></td><td><button type="button" class="btn btn-success num" onclick="confirm(\'room4\', ' + i + ')"' + (data.room4[i].num == 0 ? '><i class="fas fa-check"></i>' : ' disabled><i class="fas fa-times"></i>') + '</button></td></tr>');
          now[i + 1] = now[i].clone().add(10, 'minutes');
        }
        num = $('#input').val();
      });
    </script>
  </body>
</html>